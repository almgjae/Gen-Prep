<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ìƒê¸°ë¶€ ë©´ì ‘ ì¤€ë¹„ Â· ê°œì¸í˜• (ë¡œì»¬ Â· ë‹¤í¬ Â· íƒ€ì´ë¨¸ Â· íŒíŠ¸)</title>
<style>
  :root{
    --bg:#0f172a; --bg2:#0b1022; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#7c3aed; --accent2:#22d3ee; --danger:#ef4444; --ok:#10b981; --border:#1f2937;
    --chip:#1e293b; --shadow: rgba(2,6,23,.3);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(135deg, var(--bg), var(--bg2)); color:var(--text);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,"Apple Color Emoji","Segoe UI Emoji";
    letter-spacing:.2px;
  }
  a{color:inherit; text-decoration:none}
  .app{display:grid; grid-template-columns: 280px 1fr; height:100%; transition: grid-template-columns .2s ease-in-out;}
  .app.collapsed { grid-template-columns: 0px 1fr; }
  .app.collapsed .sidebar { transform: translateX(-100%); transition: transform .2s ease-in-out; }
  .sidebar{
    border-right:1px solid var(--border); background:rgba(15,23,42,.08);
    backdrop-filter: blur(6px); padding:16px 12px; display:flex; flex-direction:column; gap:12px;
    height: 100%; /* Fix: Sidebar height to 100% for independent scrolling */
    overflow-y: auto; /* Fix: Allow sidebar to scroll */
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:700}
  .brand svg{width:20px;height:20px}
  .pill{font-size:12px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
  .nav{display:flex; flex-direction:column; gap:6px; margin-top:4px}
  .nav a{padding:10px 12px; border-radius:10px; border:1px solid transparent}
  .nav a.active{background:rgba(124,58,237,.15); border-color:#3b246a}
  .muted{color:var(--muted)}
  .divider{height:1px; background:var(--border); margin:8px 0}
  .subjects{display:flex; flex-direction:column; gap:6px; overflow:auto; padding-right:4px}
  .chip{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:var(--chip); border:1px solid var(--border); cursor:pointer; white-space:nowrap}
  .chip.active{outline:2px solid var(--accent)}
  .row{display:flex; align-items:center; gap:8px}
  .row-nowrap{display:flex; align-items:center; gap:8px; flex-wrap:nowrap}
  .col{display:flex; flex-direction:column; gap:8px}
  .input, .search, .field, select{
    border:1px solid var(--border); background:var(--bg2); color:var(--text); border-radius:12px; padding:10px 12px; outline:none; width:100%;
  }
  .inline-field{ width:auto !important; min-width:80px; }
  .button{
    border:1px solid var(--border); background:linear-gradient(180deg, #1f1147, #160c36);
    border-color:#261a57; cursor:pointer; user-select:none;
    display:inline-flex; align-items:center; justify-content:center; width:auto; white-space:nowrap; color:var(--text);
  }
  .button:hover{filter:brightness(1.05)}
  .button.small{padding:8px 12px; border-radius:10px}
  .button.ghost{background:transparent; border-color:var(--border); color:var(--text)}
  .button.danger{background:linear-gradient(180deg,#3d0d12,#28090c); border-color:#5f141a; color:#fecaca}
  .topbar{display:flex; gap:8px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); background:rgba(2,6,23,.05); backdrop-filter: blur(6px)}
  .topbar .search{max-width:360px}
  .main{display:flex; flex-direction:column; height:100%}
  .content{padding:16px; overflow:auto; height:100%}
  .card{background:rgba(17,24,39,.06); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px var(--shadow)}
  h1{font-size:20px; margin:0 0 6px 0}
  h2{font-size:18px; margin:0 0 6px 0}
  label{color:var(--text)}
  .grid{display:grid; gap:12px}
  .grid-2{grid-template-columns: 1fr 1fr}
  .grid-3{grid-template-columns: repeat(3, 1fr)}
  .grid-4{grid-template-columns: repeat(4, 1fr)}
  .menu-btn{display:none}
  .subject-add-box{ max-width: 140px; }
  
  /* Fix: Hide scrollbars */
  ::-webkit-scrollbar {
    width: 0;
    height: 0;
  }
  * {
    scrollbar-width: none; /* Firefox */
  }

  @media (max-width: 1000px){
    .app{grid-template-columns:1fr}
    .sidebar{position:fixed; inset:0 0 auto 0; height:65vh; transform:translateY(-110%); transition:transform .2s; z-index:40}
    .sidebar.open{transform:translateY(0)}
    .grid-2 { grid-template-columns: 1fr; }
    .menu-btn{display:block}
  }

  .empty{padding:18px; border:1px dashed var(--border); border-radius:12px; color:var(--muted); background:rgba(2,6,23,.03)}
  details{border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--bg2)}
  summary{cursor:pointer; font-weight:600}
  textarea{
    min-height:120px;
    resize:vertical;
    overflow: hidden; /* Fix: Hide scrollbar for auto-expanding textareas */
  }
  .srb-box{white-space:pre-wrap; background:var(--bg2); border:1px solid var(--border); border-radius:12px; padding:12px; min-height:220px; overflow-wrap: break-word; overflow-y: auto;}
  .toolbar{display:flex; gap:8px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap}
  .tag{font-size:12px; padding:2px 8px; border:1px solid var(--border); border-radius:999px}
  .table{width:100%; border-collapse: collapse}
  .table th,.table td{padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
  .toast{position:fixed; right:18px; bottom:18px; padding:12px 14px; border-radius:12px; background:rgba(16,185,129,.15); color:#d1fae5; border:1px solid rgba(16,185,129,.35); backdrop-filter: blur(6px); display:none; z-index:50}
  .toast.error{background:rgba(239,68,68,.1); color:#fecaca; border-color:rgba(239,68,68,.35)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; background:var(--bg2); border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:var(--text)}
  .timer{font-variant-numeric: tabular-nums; font-weight:700}
  .bar{height:10px; border-radius:999px; border:1px solid var(--border); background:rgba(2,6,23,.25); overflow:hidden}
  .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); transition: width .2s linear}
  .timer-danger{color:#fecaca}
  .hscroll{display:flex; gap:8px; overflow:auto; padding-bottom:4px}
  ::placeholder{color:var(--muted)}
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 7a3 3 0 0 1 3-3h5l2 2h2a4 4 0 0 1 4 4v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7z" stroke="url(#g)" stroke-width="1.5"/><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="#22d3ee"/><stop offset=".9" stop-color="#7c3aed"/></linearGradient></defs></svg>
      ìƒê¸°ë¶€ ë©´ì ‘ ì¤€ë¹„ <span class="pill">ë¡œì»¬Â·ë‹¤í¬</span>
    </div>
    <nav class="nav" id="mainNav">
      <a href="#/dashboard" data-route>ğŸ  ëŒ€ì‹œë³´ë“œ</a>
      <a href="#/subjects" data-route>ğŸ“š êµê³¼ ëª©ë¡</a>
      <a href="#/practice" data-route>ğŸ¤ ì—°ìŠµ ëª¨ë“œ</a>
      <a href="#/analyze" data-route>âœï¸ ìƒê¸°ë¶€ ë¶„ì„</a>
      <a href="#/settings" data-route>âš™ï¸ ì„¤ì •</a>
    </nav>
    <div class="divider"></div>
    <div class="row">
      <input id="newSubjectInput" class="input subject-add-box" placeholder="ìƒˆ êµê³¼ëª…" />
      <button class="button small" id="addSubjectBtn">â• ì¶”ê°€</button>
    </div>
    <div class="divider"></div>
    <div class="muted">êµê³¼ ë°”ë¡œê°€ê¸°</div>
    <div class="subjects" id="subjectQuickList"></div>
    <div class="divider"></div>
    <div class="muted">ë‹¨ì¶•í‚¤: <span class="kbd">/</span> ê²€ìƒ‰, <span class="kbd">N</span> ìƒˆ êµê³¼, <span class="kbd">Space</span> ë‹¤ìŒ, <span class="kbd">S</span> ì¦ê²¨ì°¾ê¸°</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <button class="button small menu-btn" id="toggleMenu">â˜° ë©”ë‰´</button>
      <input id="searchInput" class="search" placeholder="êµê³¼ ê²€ìƒ‰: ì´ë¦„ ì¼ë¶€ ì…ë ¥ í›„ Enter" />
      <button class="button small" id="searchBtn">ğŸ” ê²€ìƒ‰</button>
      <span class="muted" id="searchHint"></span>
    </div>
    <div class="content" id="view"></div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  const LS_KEY = "interviewPrep.SPA.v6.darkOnly.hintInline";
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const app = {
    state: {
      subjects: [],
      sessions: [],
      prefs: {},
      selectedSubjectId: null
    },
    init(){
      const saved = localStorage.getItem(LS_KEY);
      if(saved){ try{ this.state = JSON.parse(saved) }catch(e){} }
      if(!this.state.subjects || this.state.subjects.length===0){
        this.state.subjects = [
          { id: uid(), name:"ë¯¸ì ë¶„", srb:"ë²šê½ƒ ê°œí™” ì˜ˆì¸¡ íƒêµ¬: ê¸°ì˜¨ ì£¼ê¸°í•¨ìˆ˜ T(t) ëª¨ë¸ë§, ë¯¸ë¶„ìœ¼ë¡œ ì „í™˜ì  íƒìƒ‰, ì •ì ë¶„ìœ¼ë¡œ ëˆ„ì  ì €ì˜¨/ê³ ì˜¨ëŸ‰ ì‚°ì¶œ, ì„ê³„ ë„ë‹¬ ì‹œì  ê·¼ì‚¬.", questions:[
            { id: uid(), text:"ë²šê½ƒ ê°œí™” ì‹œê¸°ì˜ ë¶ˆí™•ì‹¤ì„± ë¬¸ì œëŠ”?", answer:"", hint:"ê¸°ì˜¨ ë³€ë™ì„±Â·ì´ìƒê³ ì˜¨/í•œíŒŒë¡œ ëˆ„ì  ëƒ‰Â·ì˜¨ëŸ‰ì— ì¡ìŒ â†’ ì˜ˆì¸¡ ì˜¤ì°¨â†‘", starred:false, source:"manual", createdAt:now(), updatedAt:now() }
          ], createdAt: now(), updatedAt: now() },
          { id: uid(), name:"ê³ ê¸‰ ìƒëª…ê³¼í•™", srb:"í™€ë¦¬ ë°”ì§ˆ ê´‘ì£¼ê¸°ì„± íƒêµ¬: ì•¼ê°„ 2/4/6h ê´‘ì¡°ì‚¬, 6hì—ì„œ ê°œí™” ì§€ì—°Â·ì—½ìˆ˜ ì¦ê°€(1.6ë°°). ê´‘ì£¼ê¸° ì¡°ì ˆë¡œ ìƒí’ˆì„± ê°œì„  ê°€ëŠ¥ì„± ë¶„ì„.", questions:[
            { id: uid(), text:"í”Œë¡œë¦¬ì  ì´ ë­ì•¼?", answer:"", hint:"ìì—ì„œ ë§Œë“¤ì–´ì ¸ ì •ì•„ë¡œ ì´ë™í•˜ëŠ” ê°œí™” ì‹ í˜¸(FT ë³µí•©ì²´)", starred:false, source:"manual", createdAt:now(), updatedAt:now() }
          ], createdAt: now(), updatedAt: now() }
        ];
        this.state.selectedSubjectId = this.state.subjects[0].id;
      } else {
        // migrate: ensure each question has hint
        this.state.subjects.forEach(s=> (s.questions||[]).forEach(q=>{ if(typeof q.hint!=="string") q.hint=""; }));
      }
      if(!this.state.sessions) this.state.sessions = [];
      if(!this.state.prefs) this.state.prefs = {};

      this.cacheEls();
      this.bind();
      this.renderSidebar();
      this.route();
    },
    cacheEls(){
      this.sidebar = $("#sidebar");
      this.subjectQuickList = $("#subjectQuickList");
      this.newSubjectInput = $("#newSubjectInput");
      this.addSubjectBtn = $("#addSubjectBtn");
      this.searchInput = $("#searchInput");
      this.searchBtn = $("#searchBtn");
      this.searchHint = $("#searchHint");
      this.view = $("#view");
      this.toggleMenu = $("#toggleMenu");
      this.app = $("#app");
      this.mainNav = $("#mainNav");
    },
    bind(){
      window.addEventListener("hashchange", ()=> this.route());
      this.addSubjectBtn.addEventListener("click", ()=> this.addSubject());
      this.newSubjectInput.addEventListener("keydown", e=>{ if(e.key==="Enter") this.addSubject(); });
      this.searchBtn.addEventListener("click", ()=> this.searchGo());
      this.searchInput.addEventListener("keydown", e=>{ if(e.key==="Enter") this.searchGo(); });

      document.addEventListener("keydown", (e)=>{
        if(e.key==="/"){ e.preventDefault(); this.searchInput.focus(); }
        if(e.key.toLowerCase()==="n"){ this.newSubjectInput.focus(); }
        if(e.key==="Escape"){ this.sidebar.classList.remove("open"); this.app.classList.remove("collapsed"); }
      });
      this.toggleMenu.addEventListener("click", ()=> {
        if(window.innerWidth <= 1000){
          this.sidebar.classList.toggle("open");
        } else {
          this.app.classList.toggle("collapsed");
        }
      });
      // Fix: Close sidebar when a main nav item is clicked on mobile
      this.mainNav.addEventListener("click", (e) => {
          if (e.target.tagName === 'A' && window.innerWidth <= 1000) {
              this.sidebar.classList.remove("open");
          }
      });
    },
    save(){ localStorage.setItem(LS_KEY, JSON.stringify(this.state)); },
    toast(msg, err=false){
      const t = $("#toast"); t.textContent = msg; t.classList.toggle("error", !!err);
      t.style.display="block"; setTimeout(()=> t.style.display="none", 1600);
    },
    uidForName(name){ const s=this.state.subjects.find(x=>x.name.toLowerCase()===name.toLowerCase()); return s?.id||null; },
    addSubject(nameFromArg){
      const name = (nameFromArg ?? this.newSubjectInput.value).trim();
      if(!name){ this.toast("êµê³¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", true); return; }
      if(this.uidForName(name)){ this.toast("ì´ë¯¸ ìˆëŠ” êµê³¼ì…ë‹ˆë‹¤", true); return; }
      const sub = { id: uid(), name, srb:"", questions:[], createdAt: now(), updatedAt: now() };
      this.state.subjects.push(sub);
      this.state.selectedSubjectId = sub.id;
      this.newSubjectInput.value="";
      this.save(); this.renderSidebar();
      location.hash = "#/subjects/" + sub.id;
    },
    deleteSubject(id){
      const idx = this.state.subjects.findIndex(s=>s.id===id);
      if(idx<0) return;
      if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”? ì´ êµê³¼ì˜ ì§ˆë¬¸ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.")) return;
      this.state.subjects.splice(idx,1);
      if(this.state.selectedSubjectId===id) this.state.selectedSubjectId = this.state.subjects[0]?.id || null;
      this.save(); 
      this.renderSidebar(); 
      // Fix: Call viewSubjects() directly to ensure immediate re-render
      this.viewSubjects();
      location.hash = "#/subjects";
      this.toast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
    },
    renameSubject(id){
      const s = this.state.subjects.find(x=>x.id===id); if(!s) return;
      const name = prompt("ìƒˆ êµê³¼ëª…", s.name); if(!name) return;
      if(this.uidForName(name) && this.uidForName(name)!==id){ this.toast("ë™ì¼ ì´ë¦„ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤", true); return; }
      s.name = name.trim(); s.updatedAt = now(); this.save(); this.renderSidebar(); this.route(); this.toast("ì´ë¦„ ë³€ê²½ë¨");
    },
    searchGo(){
      const q = this.searchInput.value.trim().toLowerCase();
      if(!q){ this.toast("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”", true); return; }
      const matches = this.state.subjects.filter(s=> s.name.toLowerCase().includes(q));
      if(matches.length===0){ this.searchHint.textContent = "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"; this.toast("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ", true); return; }
      this.searchHint.textContent = `ì¼ì¹˜: ${matches.map(m=>m.name).join(", ")}`;
      location.hash = "#/subjects/" + matches[0].id;
    },
    renderSidebar(){
      $$("#mainNav a[data-route]").forEach(a=> a.classList.toggle("active", location.hash.startsWith(a.getAttribute("href"))));
      this.subjectQuickList.innerHTML = "";
      if(this.state.subjects.length===0){
        this.subjectQuickList.innerHTML = `<div class="empty">êµê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
      }else{
        this.state.subjects.forEach(s=>{
          const btn = document.createElement("a");
          btn.href = "#/subjects/" + s.id;
          btn.className = "chip" + (this.state.selectedSubjectId===s.id ? " active" : "");
          btn.innerHTML = `<span>${s.name}</span>`;
          this.subjectQuickList.appendChild(btn);
        });
      }
    },
    route(){
      const hash = location.hash || "#/dashboard";
      this.renderSidebar();
      const [_, route, id] = hash.split("/");
      switch(route){
        case "dashboard": return this.viewDashboard();
        case "subjects": return id ? this.viewSubject(id) : this.viewSubjects();
        case "practice": return this.viewPractice();
        case "analyze": return this.viewAnalyze();
        case "settings": return this.viewSettings();
        default: location.hash = "#/dashboard";
      }
    },

    /* ---------- Views ---------- */
    viewDashboard(){
      const recent = [...this.state.subjects].sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0)).slice(0,5);
      const unanswered = this.state.subjects.reduce((acc,s)=> acc + s.questions.filter(q=>!q.answer).length ,0);
      const totalQ = this.state.subjects.reduce((acc,s)=> acc + s.questions.length ,0);
      this.view.innerHTML = `
        <div class="grid grid-3">
          <div class="card">
            <h1>ì˜¤ëŠ˜ í•  ì¼</h1>
            <div class="row">
              <a class="button small" href="#/practice">ì—°ìŠµ ì‹œì‘</a>
              <a class="button ghost small" href="#/subjects">êµê³¼ ê´€ë¦¬</a>
            </div>
          </div>
          <div class="card">
            <h2>ìš”ì•½</h2>
            <table class="table">
              <tr><th>êµê³¼ ìˆ˜</th><td>${this.state.subjects.length}</td></tr>
              <tr><th>ì§ˆë¬¸ ìˆ˜</th><td>${totalQ}</td></tr>
              <tr><th>ë¯¸ë‹µë³€ ì§ˆë¬¸</th><td>${unanswered}</td></tr>
            </table>
          </div>
          <div class="card" style="grid-column: 1 / -1">
            <h2>ìµœê·¼ í¸ì§‘í•œ êµê³¼</h2>
            ${ recent.length ? `<div class="hscroll">${recent.map(s=>`<a class="chip" href="#/subjects/${s.id}">${s.name}</a>`).join("")}</div>` : `<div class="empty">ìµœê·¼ í¸ì§‘ ì—†ìŒ</div>` }
          </div>
        </div>
      `;
    },

    viewSubjects(){
      const list = [...this.state.subjects].sort((a,b)=> a.name.localeCompare(b.name,"ko"));
      this.view.innerHTML = `
        <div class="card">
          <h1>êµê³¼ ëª©ë¡</h1>
          ${ list.length ? `
            <table class="table">
              <thead><tr><th>êµê³¼ëª…</th><th>ì§ˆë¬¸</th><th>ìµœê·¼ ìˆ˜ì •</th><th></th></tr></thead>
              <tbody>
                ${list.map(s=>`
                  <tr>
                    <td><a href="#/subjects/${s.id}">${s.name}</a></td>
                    <td>${s.questions.length}</td>
                    <td>${fmtTime(s.updatedAt)}</td>
                    <td class="row-nowrap">
                      <button class="button ghost small" data-rename="${s.id}">ì´ë¦„ ë³€ê²½</button>
                      <button class="button danger small" data-del="${s.id}">ì‚­ì œ</button>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">êµê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`}
        </div>
      `;
      $$("[data-rename]").forEach(btn=> btn.addEventListener("click", ()=> this.renameSubject(btn.dataset.rename)));
      $$("[data-del]").forEach(btn=> btn.addEventListener("click", ()=> this.deleteSubject(btn.dataset.del)));
    },

    viewSubject(id){
      const s = this.state.subjects.find(x=>x.id===id);
      if(!s){ this.view.innerHTML = `<div class="empty">í•´ë‹¹ êµê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
      this.state.selectedSubjectId = id; this.save(); this.renderSidebar();
      const unanswered = s.questions.filter(q=>!q.answer).length;
      this.view.innerHTML = `
        <div class="grid">
          <div class="card">
            <h1>${s.name}</h1>
            <div class="row-nowrap">
              <button class="button ghost small" id="renameBtn">ì´ë¦„ ë³€ê²½</button>
              <button class="button danger small" id="deleteBtn">êµê³¼ ì‚­ì œ</button>
              <span class="muted" style="margin-left:auto">ë¯¸ë‹µë³€ ${unanswered} / ì´ ${s.questions.length}</span>
            </div>
            <div class="divider"></div>
            <div class="muted">êµê³¼ ìƒê¸°ë¶€</div>
            <div id="srbView" class="srb-box" title="ë”ë¸”í´ë¦­ í¸ì§‘">${esc(s.srb || "ìƒê¸°ë¶€ í…ìŠ¤íŠ¸ ì—†ìŒ (ë”ë¸”í´ë¦­ ë˜ëŠ” í¸ì§‘ìœ¼ë¡œ ì…ë ¥)")}</div>
            <div id="srbEdit" style="display:none">
              <textarea id="srbTextarea" class="field" placeholder="ì´ êµê³¼ì˜ ìƒê¸°ë¶€ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ì‘ì„±í•˜ì„¸ìš”.">${escAttr(s.srb||"")}</textarea>
              <div class="toolbar">
                <button class="button small">ì €ì¥</button>
                <button class="button ghost small">ì·¨ì†Œ</button>
              </div>
            </div>
            <div class="toolbar">
              <button class="button small" id="editSrbBtn">í¸ì§‘</button>
              <a class="button small" href="#/analyze?id=${s.id}">ìƒê¸°ë¶€ ë¶„ì„</a>
              <button class="button ghost small" id="clearSrbBtn">ì§€ìš°ê¸°</button>
            </div>
          </div>
          <div class="card">
            <h2>ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸</h2>
            <div class="card" style="margin-bottom:12px; border:1px dashed var(--border); background:rgba(17,24,39,.03); padding:12px">
              <div class="row-nowrap">
                <input id="newQ" class="field" placeholder="ìƒˆë¡œìš´ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
                <button class="button small" id="addQBtn">â• ì¶”ê°€</button>
              </div>
            </div>
            ${ s.questions.length ? "" : `<div class="empty">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>` }
            <div id="qList"></div>
          </div>
        </div>
      `;
      // SRB edit
      $("#editSrbBtn").addEventListener("click", ()=>{ $("#srbView").style.display="none"; $("#srbEdit").style.display="block"; $("#srbTextarea").focus(); });
      $("#srbView").addEventListener("dblclick", ()=> $("#editSrbBtn").click());
      const srbBtns = $$("#srbEdit .button");
      srbBtns[0].addEventListener("click", ()=>{
        const t = $("#srbTextarea").value.trim(); s.srb = t; s.updatedAt = now(); this.save(); this.toast("ìƒê¸°ë¶€ ì €ì¥ë¨"); this.viewSubject(id);
      });
      srbBtns[1].addEventListener("click", ()=>{ $("#srbEdit").style.display="none"; $("#srbView").style.display="block"; });
      $("#clearSrbBtn").addEventListener("click", ()=>{ if(confirm("ìƒê¸°ë¶€ë¥¼ ë¹„ìš¸ê¹Œìš”?")){ s.srb=""; s.updatedAt=now(); this.save(); this.viewSubject(id);} });
      $("#renameBtn").addEventListener("click", ()=> this.renameSubject(id));
      $("#deleteBtn").addEventListener("click", ()=> this.deleteSubject(id));

      // manual questions
      $("#newQ").addEventListener("keydown", e=>{ if(e.key==="Enter") $("#addQBtn").click(); });
      $("#addQBtn").addEventListener("click", ()=>{
        const text = $("#newQ").value.trim(); if(!text){ this.toast("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”", true); return; }
        s.questions.push({ id:uid(), text, answer:"", hint:"", starred:false, source:"manual", createdAt:now(), updatedAt:now() });
        s.updatedAt = now(); this.save(); this.viewSubject(id); this.toast("ì§ˆë¬¸ ì¶”ê°€ë¨");
      });

      // render questions
      const qList = $("#qList");
      s.questions.forEach(q=>{
        if(typeof q.hint!=="string") q.hint="";
        const node = document.createElement("details");
        node.open = false;
        node.innerHTML = `
          <summary class="row-nowrap">
            <span>${esc(q.text)}</span>
            <span class="tag">ìˆ˜ë™</span>
            <span style="margin-left:auto" class="row-nowrap">
              <button class="button ghost small" data-star="${q.id}">${q.starred?"â˜…":"â˜†"}</button>
              <button class="button ghost small" data-del="${q.id}">ì‚­ì œ</button>
            </span>
          </summary>
          <div class="col" style="margin-top:8px">
            <label>íŒíŠ¸</label>
            <textarea class="field" data-hint="${q.id}" placeholder="í‚¤ì›Œë“œ/êµ¬ì¡°/ë‹µë³€ ë¼ˆëŒ€ ë“± íŒíŠ¸ë¥¼ ì ì–´ë‘ì„¸ìš”.">${escAttr(q.hint||"")}</textarea>
            <label>ë‹µë³€</label>
            <textarea class="field" data-ans="${q.id}" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì •ë¦¬í•˜ì„¸ìš”.">${escAttr(q.answer||"")}</textarea>
            <div class="toolbar">
              <button class="button small" data-save="${q.id}">ì €ì¥</button>
            </div>
          </div>
        `;
        qList.appendChild(node);
      });
      $$("[data-save]").forEach(btn=> btn.addEventListener("click", ()=>{
        const idq = btn.dataset.save;
        const q = s.questions.find(x=>x.id===idq);
        q.hint = $(`[data-hint="${idq}"]`).value.trim();
        q.answer = $(`[data-ans="${idq}"]`).value.trim();
        q.updatedAt = now(); s.updatedAt = now();
        this.save(); this.toast("ì €ì¥ë¨");
      }));
      $$("[data-del]").forEach(btn=> btn.addEventListener("click", ()=>{
        const idq = btn.dataset.del;
        if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
        s.questions = s.questions.filter(x=> x.id!==idq);
        s.updatedAt = now(); this.save(); this.viewSubject(id);
      }));
      $$("[data-star]").forEach(btn=> btn.addEventListener("click", ()=>{
        const idq = btn.dataset.star;
        const q = s.questions.find(x=>x.id===idq);
        q.starred = !q.starred; q.updatedAt = now(); s.updatedAt=now();
        this.save(); btn.textContent = q.starred ? "â˜…" : "â˜†";
      }));
      this.autoExpandAllTextareas();
    },

    viewAnalyze(){
      const hash = new URLSearchParams(location.hash.slice(location.hash.indexOf('?')));
      const subId = hash.get('id');
      const s = subId ? this.state.subjects.find(x=>x.id===subId) : null;
      
      this.view.innerHTML = `
        <div class="grid grid-2">
          <div class="card">
            <h1>ìƒê¸°ë¶€ ë¶„ì„</h1>
            <div class="divider"></div>
            <div class="col">
              <label>êµê³¼ ì„ íƒ</label>
              <select class="field" id="subjectSelector">
                <option value="">- ì§ì ‘ ì…ë ¥ -</option>
                ${this.state.subjects.map(sub => `<option value="${sub.id}" ${sub.id === subId ? 'selected' : ''}>${esc(sub.name)}</option>`).join('')}
              </select>
            </div>
            <div class="col" style="margin-top:12px">
              <label>ìƒê¸°ë¶€ í…ìŠ¤íŠ¸</label>
              <textarea id="srbTextarea" class="field" placeholder="ì—¬ê¸°ì— ìƒê¸°ë¶€ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”." style="min-height: 200px">${escAttr(s?.srb || '')}</textarea>
            </div>
          </div>
          <div class="card">
            <h2>ìˆ˜ë™ ë¶„ì„</h2>
            <div class="col">
              <label>íë¦„ ì •ë¦¬</label>
              <textarea id="flowTextarea" class="field" placeholder="ë©´ì ‘ê´€ì—ê²Œ ì „ë‹¬í•  ë‹µë³€ì˜ ì „ì²´ì ì¸ íë¦„ì„ ì •ë¦¬í•˜ì„¸ìš”."></textarea>
            </div>
            <div class="col">
              <label>í‚¤ì›Œë“œ ì •ë¦¬</label>
              <textarea id="keywordsTextarea" class="field" placeholder="í•µì‹¬ ë‹¨ì–´ì™€ ê°œë…ì„ ì •ë¦¬í•˜ì„¸ìš”."></textarea>
            </div>
            <div class="col">
              <label>í•µì‹¬ ë¬¸ì¥ ì •ë¦¬</label>
              <textarea id="keySentencesTextarea" class="field" placeholder="ê°€ì¥ ì¤‘ìš”í•œ ë‹µë³€ ë¬¸ì¥ì„ ì •ë¦¬í•˜ì„¸ìš”."></textarea>
            </div>
          </div>
        </div>
      `;

      const subjectSelector = $("#subjectSelector");
      const srbTextarea = $("#srbTextarea");

      subjectSelector.addEventListener('change', (e) => {
        const selectedId = e.target.value;
        const selectedSub = this.state.subjects.find(sub => sub.id === selectedId);
        srbTextarea.value = selectedSub?.srb || '';
      });
      this.autoExpandAllTextareas();
    },

    viewPractice(){
      const subs = this.state.subjects;
      this.view.innerHTML = `
        <div class="grid">
          <div class="card">
            <h1>ì—°ìŠµ ì„¤ì •</h1>
            <div class="muted">ì—°ìŠµí•  êµê³¼, ì§ˆë¬¸ ê°œìˆ˜, ë¬¸í•­ë‹¹ ì œí•œì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”.</div>
            <div class="divider"></div>
            <div class="grid grid-3" id="subChecks">
              ${ subs.map(s=>`
                <label class="chip"><input type="checkbox" data-sub="${s.id}" checked> ${esc(s.name)} <span class="muted">(${s.questions.length})</span></label>
              `).join("")}
            </div>
            <div class="col" style="margin-top: 16px;">
              <div class="row" style="align-items: center; gap: 8px; flex-wrap: wrap;">
                <label>ì§ˆë¬¸ ê°œìˆ˜</label>
                <input id="pCount" class="field inline-field" style="max-width:100px" value="10">
                <label>ë¬¸í•­ë‹¹ ì œí•œ(ì´ˆ)</label>
                <select id="pTimer" class="field inline-field" style="max-width:140px">
                  <option value="0">ë¬´ì œí•œ</option>
                  <option value="30">30ì´ˆ</option>
                  <option value="60" selected>60ì´ˆ</option>
                  <option value="90">90ì´ˆ</option>
                </select>
                <input id="pTimerCustom" class="field inline-field" style="max-width:120px" placeholder="ì§ì ‘ ì…ë ¥(ì´ˆ)">
                <button class="button small" id="startPractice">ì—°ìŠµ ì‹œì‘</button>
              </div>
            </div>
          </div>
          <div class="card" id="practiceArea" style="grid-column: 1 / -1; display:none"></div>
        </div>
      `;
      $("#startPractice").addEventListener("click", ()=>{
        const selectedIds = $$("#subChecks input[type=checkbox]:checked").map(cb=>cb.dataset.sub);
        const count = Math.max(1, parseInt($("#pCount").value,10) || 10);
        let limit = parseInt($("#pTimer").value,10) || 0;
        const custom = parseInt(($("#pTimerCustom").value||"").trim(),10);
        if(!isNaN(custom) && custom>=0) limit = custom;
        const pool = this.collectQuestions(selectedIds);
        if(pool.length===0){ this.toast("ì„ íƒ êµê³¼ì— ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤", true); return; }
        const qs = shuffle(pool).slice(0, Math.min(count, pool.length));
        this.runPractice(qs, limit);
      });
    },

    viewSettings(){
      this.view.innerHTML = `
        <div class="grid grid-2">
          <div class="card">
            <h1>ì„¤ì •</h1>
            <h2>ë°ì´í„°</h2>
            <div class="row-nowrap">
              <button class="button small" id="backupBtn">ğŸ’¾ ë°±ì—…</button>
              <button class="button ghost small" id="restoreBtn">ğŸ“‚ ë³µì›</button>
              <input type="file" id="restoreFile" accept="application/json" style="display:none">
            </div>
            <div class="divider"></div>
            <h2>ì•ˆë‚´</h2>
            <div class="muted">ìˆ˜ë™ ì§ˆë¬¸ + íŒíŠ¸ ê´€ë¦¬, íƒ€ì´ë¨¸ í¬í•¨ ì—°ìŠµ ëª¨ë“œë§Œ ì œê³µí•©ë‹ˆë‹¤.</div>
          </div>
        </div>
      `;
      $("#backupBtn").addEventListener("click", ()=>{
        const blob = new Blob([JSON.stringify(this.state, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="interview_prep_backup.json"; a.click(); URL.revokeObjectURL(url);
        this.toast("ë°±ì—… ì™„ë£Œ");
      });
      $("#restoreBtn").addEventListener("click", ()=> $("#restoreFile").click());
      $("#restoreFile").addEventListener("change", async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        try{
          const txt = await f.text(); const data = JSON.parse(txt);
          if(!data || !Array.isArray(data.subjects)) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
          if(!confirm("í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;
          this.state = data; this.save(); location.reload();
        }catch(err){ this.toast("ë³µì› ì‹¤íŒ¨: "+(err.message||"ì˜¤ë¥˜"), true); }
      });
    },

    /* ---------- Practice engine (uses hint in UI) ---------- */
    collectQuestions(subjectIds){
      const set = new Set(subjectIds);
      const qs = [];
      this.state.subjects.forEach(s=>{ if(set.has(s.id)) qs.push(...s.questions); });
      return qs;
    },
    runPractice(qs, perSec){
      const area = $("#practiceArea"); area.style.display="block";
      const hasTimer = perSec > 0;
      let idx = 0, done=false;
      let questionStart = null;
      let remaining = perSec;
      let paused = false;
      let pauseStartedAt = 0;
      let accPaused = 0;
      let timerId = null;
      const sessionStart = Date.now();

      const next = (auto=false) => {
        if(idx < qs.length-1){
          idx++;
          resetTimer();
          render();
          if(auto) app.toast("ì‹œê°„ ì¢…ë£Œ Â· ë‹¤ìŒ ë¬¸í•­");
        }else{
          finish();
        }
      };

      const resetTimer = () => {
        if(hasTimer){
          remaining = perSec;
          questionStart = Date.now();
          paused = false;
          pauseStartedAt = 0;
          accPaused = 0;
          schedule();
        }
      };

      const schedule = () => {
        if(timerId) clearInterval(timerId);
        if(!hasTimer) return;
        timerId = setInterval(tick, 100);
      };

      const tick = () => {
        if(!hasTimer || paused) return;
        const nowt = Date.now();
        const elapsed = (nowt - questionStart - accPaused) / 1000;
        const left = Math.max(0, perSec - elapsed);
        remaining = left;
        updateTimerUI();
        if(left <= 0){
          clearInterval(timerId);
          setTimeout(()=> next(true), 50);
        }
      };

      const togglePause = () => {
        if(!hasTimer) return;
        if(!paused){
          paused = true;
          pauseStartedAt = Date.now();
          updateTimerUI();
        }else{
          paused = false;
          accPaused += (Date.now() - pauseStartedAt);
          updateTimerUI();
        }
      };

      const restartQuestion = () => {
        if(!hasTimer) return;
        questionStart = Date.now();
        accPaused = 0; paused = false; remaining = perSec;
        schedule(); updateTimerUI();
      };

      const finish = () => {
        done = true; if(timerId) clearInterval(timerId);
        const elapsedSec = Math.round((Date.now() - sessionStart)/1000);
        const stars = qs.filter(q=> bookmarked.has(q.id));
        area.innerHTML = `
          <div class="card">
            <h2>ì—°ìŠµ ì¢…ë£Œ</h2>
            <p>ì´ ${qs.length}ë¬¸í•­ Â· ì¦ê²¨ì°¾ê¸° ${stars.length}ë¬¸í•­ Â· ì´ ì†Œìš” ${fmtSec(elapsedSec)}</p>
            ${ stars.length ? `<div class="col">${stars.map(q=>`<div class="chip">â˜… ${esc(q.text)}</div>`).join("")}</div>` : `<div class="empty">ì¦ê²¨ì°¾ê¸° ì—†ìŒ</div>` }
            <div class="toolbar">
              <a class="button small" href="#/practice">ë‹¤ì‹œ ì„¤ì •</a>
              <a class="button ghost small" href="#/subjects/${this.state.selectedSubjectId || this.state.subjects[0]?.id || ""}">êµê³¼ë¡œ ì´ë™</a>
            </div>
          </div>
        `;
      };

      const bookmarked = new Set();

      const updateTimerUI = () => {
        const timerEl = $("#timerText");
        const bar = $("#timerBarFill");
        const pauseBtn = $("#pauseBtn");
        if(!hasTimer || !timerEl || !bar) return;
        const secs = Math.ceil(remaining);
        timerEl.textContent = fmtSec(secs);
        bar.style.width = `${Math.max(0, Math.min(100, ((perSec - remaining)/perSec)*100))}%`;
        timerEl.classList.toggle("timer-danger", secs<=5 && !paused);
        if(pauseBtn) pauseBtn.textContent = paused ? "â–¶ ì¬ê°œ" : "â¸ ì¼ì‹œì •ì§€";
        const ses = $("#sessionElapsed"); if(ses){ const e=Math.round((Date.now()-sessionStart)/1000); ses.textContent = fmtSec(e); }
      };

      const render = () => {
        const q = qs[idx];
        if(typeof q.hint!=="string") q.hint="";
        const sesElapsed = Math.round((Date.now() - sessionStart)/1000);
        const hintText = (q.hint && q.hint.trim()) ? q.hint : (q.answer || "");
        area.innerHTML = `
          <div class="row-nowrap" style="justify-content:space-between; gap:10px">
            <div>ë¬¸í•­ ${idx+1}/${qs.length}${hasTimer ? ` Â· ë‚¨ì€ì‹œê°„ <span class="timer" id="timerText"></span>` : ""}</div>
            <div class="muted">ì„¸ì…˜ ê²½ê³¼: <span class="timer" id="sessionElapsed">${fmtSec(sesElapsed)}</span></div>
            <div class="row-nowrap">
              ${ hasTimer ? `<button class="button ghost small" id="pauseBtn">â¸ ì¼ì‹œì •ì§€</button>
              <button class="button ghost small" id="restartBtn">â†º ë¦¬ì…‹</button>` : "" }
              <button class="button ghost small" id="starBtn">${bookmarked.has(q.id)?"â˜… ì¦ê²¨ì°¾ê¸°":"â˜† ì¦ê²¨ì°¾ê¸°"}</button>
              <button class="button small" id="nextBtn">${idx<qs.length-1?"ë‹¤ìŒ":"ì¢…ë£Œ"}</button>
            </div>
          </div>
          ${ hasTimer ? `<div class="bar" style="margin-top:8px"><span id="timerBarFill"></span></div>` : "" }
          <div class="card" style="margin-top:10px">
            <h2>${esc(q.text)}</h2>
            <div class="muted">íŒíŠ¸: ${esc((hintText||"").slice(0, 160))}${(hintText&&hintText.length>160)?"...":""}</div>
          </div>
        `;
        $("#nextBtn").addEventListener("click", ()=> next(false));
        $("#starBtn").addEventListener("click", ()=>{
          if(bookmarked.has(q.id)) bookmarked.delete(q.id); else bookmarked.add(q.id);
          render();
        });
        if(hasTimer){
          $("#pauseBtn").addEventListener("click", togglePause);
          $("#restartBtn").addEventListener("click", restartQuestion);
        }
        updateTimerUI();
      };

      if(hasTimer){ resetTimer(); } else { questionStart = Date.now(); }
      render();

      document.onkeydown = (e)=>{
        if(done) return;
        if(e.code==="Space"){ e.preventDefault(); next(false); }
        if(e.key.toLowerCase()==="s"){ const q = qs[idx]; if(bookmarked.has(q.id)) bookmarked.delete(q.id); else bookmarked.add(q.id); render(); }
        if(hasTimer && e.key.toLowerCase()==="p"){ togglePause(); } // 'p' for pause
        if(hasTimer && e.key.toLowerCase()==="r"){ restartQuestion(); }
      };
    },
    
    // Fix: Auto-resize all relevant textareas
    autoExpandTextarea(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    },

    autoExpandAllTextareas() {
      const textareas = $$('textarea.field');
      textareas.forEach(el => {
        el.addEventListener('input', () => this.autoExpandTextarea(el));
        this.autoExpandTextarea(el); // Initial resize on load
      });
    }
  };

  // helpers
  function uid(){ return "id_"+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function fmtTime(t){ if(!t) return "-"; const d=new Date(t); return d.toLocaleString(); }
  function fmtSec(s){ s = Math.max(0, Math.floor(s)); const m = Math.floor(s/60), r = s%60; return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`; }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function escAttr(s){ return esc(s).replace(/"/g,"&quot;"); }
  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  app.init();
})();</script>
</body>
</html>